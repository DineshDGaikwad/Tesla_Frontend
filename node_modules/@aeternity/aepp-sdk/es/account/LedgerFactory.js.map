{"version":3,"file":"LedgerFactory.js","names":["AccountLedger","CLA","GET_ADDRESS","GET_APP_CONFIGURATION","UnsupportedVersionError","semverSatisfies","AccountBaseFactory","_ensureReadyPromise","WeakMap","_AccountLedgerFactory_brand","WeakSet","AccountLedgerFactory","constructor","transport","_classPrivateMethodInitSpec","_classPrivateFieldInitSpec","decorateAppAPIMethods","ensureReady","version","_assertClassBrand","_getAppConfiguration","call","args","_classPrivateFieldSet","Promise","resolve","getAppConfiguration","getAddress","accountIndex","verify","_ensureReady","buffer","_Buffer","alloc","writeUInt32BE","response","send","addressLength","subarray","toString","initialize","_classPrivateFieldGet2","_classPrivateFieldGet","join"],"sources":["../../src/account/LedgerFactory.ts"],"sourcesContent":["import type Transport from '@ledgerhq/hw-transport';\nimport AccountLedger, { CLA, GET_ADDRESS, GET_APP_CONFIGURATION } from './Ledger.js';\nimport { UnsupportedVersionError } from '../utils/errors.js';\nimport { Encoded } from '../utils/encoder.js';\nimport semverSatisfies from '../utils/semver-satisfies.js';\nimport AccountBaseFactory from './BaseFactory.js';\n\ninterface AppConfiguration {\n  version: string;\n}\n\n/**\n * A factory class that generates instances of AccountLedger based on provided transport.\n */\nexport default class AccountLedgerFactory extends AccountBaseFactory {\n  /**\n   * @param transport - Connection to Ledger to use\n   */\n  constructor(readonly transport: Transport) {\n    super();\n    transport.decorateAppAPIMethods(this, ['getAddress', 'getAppConfiguration'], 'w0w');\n  }\n\n  #ensureReadyPromise?: Promise<void>;\n\n  /**\n   * It throws an exception if Aeternity app on Ledger has an incompatible version, not opened or\n   * not installed.\n   */\n  async ensureReady(): Promise<void> {\n    const { version } = await this.#getAppConfiguration();\n    const args = [version, '0.4.4', '0.5.0'] as const;\n    if (!semverSatisfies(...args))\n      throw new UnsupportedVersionError('Aeternity app on Ledger', ...args);\n    this.#ensureReadyPromise = Promise.resolve();\n  }\n\n  async #ensureReady(): Promise<void> {\n    this.#ensureReadyPromise ??= this.ensureReady();\n    return this.#ensureReadyPromise;\n  }\n\n  async #getAppConfiguration(): Promise<AppConfiguration> {\n    const response = await this.transport.send(CLA, GET_APP_CONFIGURATION, 0x00, 0x00);\n    return {\n      version: [response[1], response[2], response[3]].join('.'),\n    };\n  }\n\n  /**\n   * @returns the version of Aeternity app installed on Ledger wallet\n   */\n  async getAppConfiguration(): Promise<AppConfiguration> {\n    return this.#getAppConfiguration();\n  }\n\n  /**\n   * Get `ak_`-prefixed address for a given account index.\n   * @param accountIndex - Index of account\n   * @param verify - Ask user to confirm address by showing it on the device screen\n   */\n  async getAddress(accountIndex: number, verify = false): Promise<Encoded.AccountAddress> {\n    await this.#ensureReady();\n    const buffer = Buffer.alloc(4);\n    buffer.writeUInt32BE(accountIndex, 0);\n    const response = await this.transport.send(\n      CLA,\n      GET_ADDRESS,\n      verify ? 0x01 : 0x00,\n      0x00,\n      buffer,\n    );\n    const addressLength = response[0];\n    return response.subarray(1, 1 + addressLength).toString('ascii') as Encoded.AccountAddress;\n  }\n\n  /**\n   * Get an instance of AccountLedger for a given account index.\n   * @param accountIndex - Index of account\n   */\n  async initialize(accountIndex: number): Promise<AccountLedger> {\n    return new AccountLedger(this.transport, accountIndex, await this.getAddress(accountIndex));\n  }\n}\n"],"mappings":"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","ignoreList":[]}