{"version":3,"file":"common.js","names":["decode","rlpDecode","encode","rlpEncode","ArgumentError","DecodeError","SchemaNotFoundError","InternalError","readInt","getSchema","schemas","Tag","tag","version","subSchemas","filter","s","constValue","length","defaultSchema","find","schema","constValueOptional","Object","entries","packRecord","params","extraParams","encoding","binary","map","key","field","serialize","unpackRecord","encodedRecord","expectedTag","fromEntries","name","index","deserialize"],"sources":["../../../src/tx/builder/common.ts"],"sourcesContent":["import { decode as rlpDecode, encode as rlpEncode } from 'rlp';\nimport { Field, BinaryData } from './field-types/interface.js';\nimport {\n  ArgumentError,\n  DecodeError,\n  SchemaNotFoundError,\n  InternalError,\n} from '../../utils/errors.js';\nimport { Encoding, Encoded, encode, decode } from '../../utils/encoder.js';\nimport { readInt } from './helpers.js';\n\ntype Schemas = ReadonlyArray<{\n  tag: { constValue: number } & Field;\n  version: { constValue: number; constValueOptional: boolean } & Field;\n}>;\n\nexport function getSchema(\n  schemas: Schemas,\n  Tag: { [key: number]: string },\n  tag: number,\n  version: number | undefined,\n): Array<[string, Field]> {\n  const subSchemas = schemas.filter((s) => s.tag.constValue === tag);\n  if (subSchemas.length === 0) throw new SchemaNotFoundError(`${Tag[tag]} (${tag})`, 0);\n  if (version == null) {\n    const defaultSchema = subSchemas.find((schema) => schema.version.constValueOptional);\n    if (defaultSchema == null)\n      throw new InternalError(`Can't find default schema of ${Tag[tag]} (${tag})`);\n    version = defaultSchema.version.constValue;\n  }\n  const schema = subSchemas.find((s) => s.version.constValue === version);\n  if (schema == null) throw new SchemaNotFoundError(`${Tag[tag]} (${tag})`, version);\n  return Object.entries(schema);\n}\n\nexport function packRecord<E extends Encoding>(\n  schemas: Schemas,\n  Tag: { [key: number]: string },\n  params: {\n    tag: number;\n    version?: number;\n    [k: string]: unknown;\n  },\n  extraParams: { [k: string]: unknown },\n  encoding: E,\n): Encoded.Generic<E> {\n  const schema = getSchema(schemas, Tag, params.tag, params.version);\n  const binary = schema.map(([key, field]) =>\n    field.serialize(params[key], { ...params, ...extraParams }, params),\n  );\n  return encode(rlpEncode(binary), encoding);\n}\n\nexport function unpackRecord(\n  schemas: Schemas,\n  Tag: { [key: number]: string },\n  encodedRecord: Encoded.Any,\n  expectedTag: number | undefined,\n  extraParams: { [k: string]: unknown },\n): unknown {\n  const binary = rlpDecode(decode(encodedRecord));\n  const tag = +readInt(binary[0] as Buffer);\n  const version = +readInt(binary[1] as Buffer);\n  const schema = getSchema(schemas, Tag, tag, version);\n  if (expectedTag != null && expectedTag !== tag) {\n    throw new DecodeError(`Expected ${Tag[expectedTag]} tag, got ${Tag[tag]} instead`);\n  }\n  if (binary.length !== schema.length) {\n    throw new ArgumentError('RLP length', schema.length, binary.length);\n  }\n  return Object.fromEntries(\n    schema.map(([name, field], index) => [\n      name,\n      field.deserialize(binary[index] as BinaryData, extraParams),\n    ]),\n  );\n}\n"],"mappings":"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","ignoreList":[]}